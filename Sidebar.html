<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <!-- The CSS package above applies Google styling to buttons and other elements. -->
    <style>
    <!-- Some supplemental styling stolen from the Google Translate Apps Script example. -->
    .branding-below {
      bottom: 56px;
      top: 0;
    }
    .width-100 {
      width: 100%;
    }
    .text-box{
      border-style:solid;
    }
    </style>
  </head>
  <body>
    <div class="sidebar branding-below">
      <div class="block form-group">
        <b>Label text preview: </b>
        <p class="text-box" id="labelPreview"> Testing </p>
      </div>
      <div id="printersDiv">
        <b> Printer: </b>
        <p id="printerName"></p>
        <button id="printButton">Print</button>
	    </div>
    </div>
    <div class="sidebar bottom">
      <textarea class="width-100 secondary" id="console-output" rows="20"></textarea>
    </div>

    <!-- JQuery import -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <!-- Importing this makes the whole google sheet/ form connection insecure  -->
  <!-- <script src="https://rawgit.com/errontitus/dymo_cryo_label/master/dymo_frameworks/DYMO.Label.Framework.2.0.2.js"></script> -->
    


    <script>
      var labelText;
      var printerNameFinal = "No printer found.";
      var printers;

      $( document ).ready(function() {
        
        google.script.run.withSuccessHandler(function(ret){
          labelText = ret;
          var obj = $("#labelPreview").text(labelText);
          obj.html(obj.html().replace(/\n/g,'<br/>'));
        }).getFormattedLastNewline();
        
        console.log("Looking for DYMO Printers.");

        google.script.run.withSuccessHandler(function(ret){
          printers = ret;
          console.log(printers);
          if(printers.length == 0){
            console.log("No DYMO printers are installed.");
          }
          else{
            printers.forEach(element => console.log(element.name));
            console.log("Finding a LabelWriter printer");

            var i = 0, max;
            for (var i = 0; i < printers.length; ++i){
              var printer = printers[i];
              if (printer.printerType == "LabelWriterPrinter")
              {
                  console.log("Printer connected: " + printerNameFinal);
                  printerNameFinal = printer.name;
                  $("#printerName").text(printerNameFinal);
                  console.log("Printer connected: " + printerNameFinal);
                  break;
              }
            }
                  
            if (printerName == "")
                console.log("No LabelWriter printers found. Install LabelWriter printer");
                
          }
        }).getDymoPrinters();
        
        
        // console.log(labelText);

        $( "#printButton" ).click(function() {
           try
            {
                var label;
                // open label
                google.script.run.withSuccessHandler(function(ret){
                  label=ret;
                }).loadXmlAsLabel();
                // set label text
                label.setObjectText("Text", labelText);
                
                // finally print the label
                label.print(printerNameFinal);
            }
            catch(e)
            {
                alert(e.message || e);
            }
        }
        );
      });
    </script>


    <!-- Writing the console output to the sidebar. From Dymo Cryolabel -->
    <script> 
    var logger = (function() {
      // Store the pointer to the runtime's console.log function.
      var nativeLog = console.log;

      // Override console.log with our own function.
      console.log = function (message) {
        // Do not call console.log from within this function.
        _updateTextArea(message);
        nativeLog.apply(console, arguments);
      }; 
      
      function _updateTextArea(message) {
        // Do not call console.log from within this function.
        var element = document.getElementById("console-output");
        var prefix = "";
        if (element.value) {prefix = element.value + "\n";}
        element.value = prefix + message;
        element.scrollTop = element.scrollHeight; 
      }
    })();
    </script>
  </body>
</html>
